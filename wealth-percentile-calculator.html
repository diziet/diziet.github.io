<!DOCTYPE html>
<html>
<head>
    <title>World Wealth Percentile Calculator (Pareto Distribution for Net Worth)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .input-section {
            margin-bottom: 20px;
        }
        #result, #resultUnder18 {
            margin-top: 20px;
            font-weight: bold;
        }
        input, button {
            padding: 8px;
            margin-right: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .explanation {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f8f8;
            border-left: 5px solid #4CAF50;
        }
    </style>
</head>
<body>
    <h2>World Wealth Percentile Calculator (Pareto Distribution for Net Worth)</h2>
    
    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div style="flex: 1; padding: 15px; border: 1px solid #ccc; border-radius: 5px;">
            <h3>Adult Population (18+)</h3>
            <div class="input-section">
                <p>Enter your wealth in USD:</p>
                <input type="text" id="userWealth" placeholder="Enter your wealth" oninput="formatNumberInput(this)">
                <button onclick="calculatePercentile(false)">Calculate Percentile</button>
            </div>
            <p id="result"></p>
            <div id="detailedResults"></div>
        </div>
        
        <div style="flex: 1; padding: 15px; border: 1px solid #ccc; border-radius: 5px;">
            <h3>Under 18 Population</h3>
            <div class="input-section">
                <p>Enter your wealth in USD:</p>
                <input type="text" id="userWealthUnder18" placeholder="Enter your wealth" oninput="formatNumberInput(this)">
                <button onclick="calculatePercentile(true)">Calculate Percentile</button>
            </div>
            <p id="resultUnder18"></p>
            <div id="detailedResultsUnder18"></div>
        </div>
    </div>
    
    <h3>Adult Wealth Distribution</h3>
    <div id="percentileTable"></div>
    
    <h3>Under 18 Wealth Distribution</h3>
    <div id="percentileTableUnder18"></div>
    
    <div class="explanation">
        <h3>About This Calculator</h3>
        <p>This calculator uses a Pareto distribution to estimate wealth percentiles worldwide for both adults and people under 18. 
        Unlike linear interpolation, the Pareto distribution better represents how wealth is distributed in reality, with a "long tail" 
        where a small percentage of people own a disproportionately large amount of wealth.</p>
        
        <p>The adult distribution is based on global wealth data, while the under-18 distribution uses a mixed model where:</p>
        <ul>
            <li>The maximum wealth for under-18s is capped at $1 billion</li>
            <li>The distribution is more compressed, reflecting that most under-18s have very little personal wealth</li>
            <li>The wealth thresholds are generally lower, especially at higher percentiles</li>
        </ul>
        
        <p>The data points used are calibrated based on real-world wealth distribution estimates from the 2023 UBS Global Wealth Report deciles and Forbes wealth lists, but should be considered 
        approximations. The calculator covers approximately 7.9 billion people in total (5.4 billion adults and 2.5 billion under-18s).</p>
    </div>

    <script>
        // inspired by work here: https://rltvty.xyz/wealth_percentile_calculator.html

        // Population sizes
        const adultPopulation = 5_400_000_000;
        const under18Population = 2_500_000_000;
        
        // Data points for adult and under-18 populations in 2D array format [percentile, wealth]
        const adultWealthData = [
            [0,                  -99_999],
            [10,                    -168],
            [20,                     855],
            [30,                   2_236],
            [40,                   4_569],
            [50,                   8_654],
            [60,                  14_589],
            [70,                  25_669],
            [80,                  52_187],
            [90,                 137_333],
            [99,               1_081_342],
            [99.91,            5_000_000],
            [99.95,           10_000_000],
            [99.996,          50_000_000],
            [99.99988,       100_000_000],
            [99.99995,     1_000_000_000],
            [99.9999998, 100_000_000_000],
            [100,        252_000_000_000]
        ];
        

        // Generated by assuming richest under 18 year old has a 1 billion dollar net worth
        const under18WealthData = [
            [0,                -99_999],
            [10,                  -168],
            [20,                     0],
            [30,                 1_740],
            [40,                 3_050],
            [50,                 4_830],
            [60,                 7_240],
            [70,                11_000],
            [80,                16_000],
            [90,                24_000],
            [99,                37_000],
            [99.91,             55_000],
            [99.95,            100_000],
            [99.996,           500_000],
            [99.99988,       1_000_000],
            [99.99995,      10_000_000],
            [99.9999998, 1_000_000_000],
            [100,        1_000_000_000]
        ];
        
        // Extract percentile and wealth points for easier access
        const adultPercentilePoints = adultWealthData.map(point => point[0]);
        const adultWealthPoints = adultWealthData.map(point => point[1]);
        const under18PercentilePoints = under18WealthData.map(point => point[0]);
        const under18WealthPoints = under18WealthData.map(point => point[1]);
        
        // Function to format number input with spaces for readability
        function formatNumberInput(input) {
            // Get cursor position before formatting
            const cursorPosition = input.selectionStart;
            const previousLength = input.value.length;
            
            // Remove any non-digit characters, but keep minus sign at beginning
            let value = input.value.replace(/[^\d-]/g, '');
            if (value.indexOf('-') > 0) {
                value = value.replace(/-/g, '');
                if (value.length > 0) {
                    value = '-' + value;
                }
            } else if (value.startsWith('--')) {
                value = '-' + value.substring(2);
            }
            
            // Add spaces between every 3 digits, but only for the integer part
            if (value) {
                const isNegative = value.startsWith('-');
                let numberPart = isNegative ? value.substring(1) : value;
                
                // Format with spaces
                let formattedValue = '';
                for (let i = 0; i < numberPart.length; i++) {
                    if (i > 0 && (numberPart.length - i) % 3 === 0) {
                        formattedValue += ' ';
                    }
                    formattedValue += numberPart[i];
                }
                
                // Add back the negative sign if needed
                input.value = isNegative ? '-' + formattedValue : formattedValue;
                
                // Adjust cursor position based on added spaces
                const newLength = input.value.length;
                const addedSpaces = newLength - previousLength;
                
                // Calculate how many spaces were added before the cursor
                let spacesBefore = 0;
                if (addedSpaces > 0) {
                    const valueBeforeCursor = input.value.substring(0, cursorPosition + spacesBefore);
                    spacesBefore = (valueBeforeCursor.match(/ /g) || []).length;
                }
                
                // Set the cursor position, accounting for added spaces
                input.setSelectionRange(cursorPosition + spacesBefore, cursorPosition + spacesBefore);
            }
        }
        
        // Function to fit Pareto parameter between two wealth points
        function fitParetoParameter(wealth1, percentile1, wealth2, percentile2) {
            // Convert percentiles to proportions of people richer
            const proportion1 = (100 - percentile1) / 100;
            const proportion2 = (100 - percentile2) / 100;
            
            // For a Pareto distribution, if P(X > x) = (x_min/x)^α
            // Taking logs: log(P(X > x)) = α * log(x_min/x)
            
            // We don't know x_min directly, but we can solve for α using the two points
            // log(proportion1/proportion2) = α * log(wealth2/wealth1)
            
            if (wealth1 <= 0 || wealth2 <= 0) {
                // Handle negative or zero wealth values
                return { alpha: 1, x_min: null }; // Default alpha value
            }
            
            const alpha = Math.log(proportion1/proportion2) / Math.log(wealth2/wealth1);
            
            // We can now solve for x_min using either point
            // proportion1 = (x_min/wealth1)^α => x_min = wealth1 * Math.pow(proportion1, 1/alpha)
            const x_min = wealth1 * Math.pow(proportion1, 1/alpha);
            
            return { alpha, x_min };
        }
        
        // FIXED paretoEstimate function with all identified issues fixed
        function paretoEstimate(wealth, isUnder18 = false) {
            // Select appropriate data based on age group
            const points = isUnder18 ? under18WealthPoints : adultWealthPoints;
            const percentiles = isUnder18 ? under18PercentilePoints : adultPercentilePoints;
            const population = isUnder18 ? under18Population : adultPopulation;
            
            // Step 1: Find the appropriate interval for the wealth value
            let lowerIndex = -1;
            
            // Special case for wealth values at exactly a threshold point
            const exactMatch = points.indexOf(wealth);
            if (exactMatch !== -1) {
                const nextPercentile = exactMatch < percentiles.length - 1 ? percentiles[exactMatch] : 100;
                return {
                    percentile: percentiles[exactMatch],
                    richerPeople: Math.floor(population * ((100 - nextPercentile) / 100)),
                    alpha: 1,
                    x_min: null
                };
            }
            
            // Standard interval finding
            for (let i = 0; i < points.length - 1; i++) {
                if (wealth > points[i] && wealth < points[i + 1]) {
                    lowerIndex = i;
                    break;
                }
            }
            
            // Step 2: Handle wealth values below the first threshold or above the last
            if (lowerIndex === -1) {
                if (wealth < points[0]) {
                    // FIX 1: For wealth below the first threshold, use better interpolation logic
                    
                    // If the first threshold is negative, we need a different approach
                    if (points[0] < 0) {
                        if (wealth < 0) {
                            // If both wealth and threshold are negative, we can use ratio of absolute values
                            // This ensures that more negative wealth = lower percentile
                            const ratioOfMagnitudes = Math.abs(wealth) / Math.abs(points[0]);
                            const percentile = percentiles[0] * (ratioOfMagnitudes <= 1 ? ratioOfMagnitudes : 1);
                            return {
                                percentile: percentile,
                                richerPeople: Math.floor(population * ((100 - percentile) / 100)),
                                alpha: 1,
                                x_min: null
                            };
                        } else {
                            // If wealth is positive but threshold is negative, we're better than threshold
                            // Use linear interpolation between threshold and next positive point
                            if (points.length > 1 && points[1] > 0) {
                                // Find percentage position between 0 and points[1]
                                const ratio = wealth / points[1];
                                // Start from threshold percentile and interpolate to next percentile
                                const percentile = percentiles[0] + 
                                    (percentiles[1] - percentiles[0]) * (ratio * (points[1] / (points[1] - points[0])));
                                return {
                                    percentile: Math.max(percentile, percentiles[0]),
                                    richerPeople: Math.floor(population * ((100 - Math.max(percentile, percentiles[0])) / 100)),
                                    alpha: 1,
                                    x_min: null
                                };
                            } else {
                                // If we don't have a good second reference point, just use first percentile
                                return {
                                    percentile: percentiles[0],
                                    richerPeople: Math.floor(population * ((100 - percentiles[0]) / 100)),
                                    alpha: 1,
                                    x_min: null
                                };
                            }
                        }
                    } else if (points[0] === 0) {
                        // If threshold is exactly zero, we can't do ratio-based interpolation
                        // Just return the threshold percentile for negative values
                        if (wealth < 0) {
                            return {
                                percentile: 0, // Below the lowest threshold
                                richerPeople: population,
                                alpha: 1,
                                x_min: null
                            };
                        } else {
                            // Should never happen because we caught exact match earlier
                            return {
                                percentile: percentiles[0],
                                richerPeople: Math.floor(population * ((100 - percentiles[0]) / 100)),
                                alpha: 1,
                                x_min: null
                            };
                        }
                    } else {
                        // For positive first threshold, we can use the original ratio approach
                        // Ensure we don't go below 0% for very negative wealth
                        const percentile = Math.max(0, percentiles[0] * (wealth / points[0]));
                        return {
                            percentile: percentile,
                            richerPeople: Math.floor(population * ((100 - percentile) / 100)),
                            alpha: 1,
                            x_min: null
                        };
                    }
                }
                
                if (wealth > points[points.length - 1]) {
                    // For wealth above the highest threshold, assign 100th percentile
                    return {
                        percentile: 100,
                        richerPeople: 0,
                        alpha: 1,
                        x_min: null
                    };
                }
            }
            
            // Step 3: For normal cases, do linear or Pareto interpolation
            if (lowerIndex !== -1) {
                // FIX 2: Better handling of wealth intervals containing zero or negative values
                const wealth1 = points[lowerIndex];
                const wealth2 = points[lowerIndex + 1];
                const percentile1 = percentiles[lowerIndex];
                const percentile2 = percentiles[lowerIndex + 1];
                
                // Check if this interval has issues with Pareto fitting
                // Issues occur when either wealth point is zero or negative, or both have same value
                if (wealth1 <= 0 || wealth2 <= 0 || wealth1 === wealth2) {
                    // Use linear interpolation for these problematic intervals
                    const percentile = percentile1 + 
                        (percentile2 - percentile1) * 
                        ((wealth - wealth1) / (wealth2 - wealth1));
                    
                    return {
                        percentile: percentile,
                        richerPeople: Math.floor(population * ((100 - percentile) / 100)),
                        alpha: 1,
                        x_min: null
                    };
                }
                
                // For intervals with positive wealth points, we can use Pareto distribution
                // Fit Pareto distribution parameters for this interval
                const { alpha, x_min } = fitParetoParameter(
                    wealth1, 
                    percentile1, 
                    wealth2, 
                    percentile2
                );
                
                // For invalid alpha, fall back to linear interpolation
                if (isNaN(alpha) || !isFinite(alpha) || alpha <= 0) {
                    const percentile = percentile1 + 
                        (percentile2 - percentile1) * 
                        ((wealth - wealth1) / (wealth2 - wealth1));
                    
                    return {
                        percentile: percentile,
                        richerPeople: Math.floor(population * ((100 - percentile) / 100)),
                        alpha: alpha,
                        x_min: x_min
                    };
                }
                
                // Calculate proportion of people richer using Pareto CDF
                // P(X > x) = (x_min/x)^α
                const proportionRicher = Math.pow(x_min / wealth, alpha);
                
                // Convert to percentile and number of richer people
                // Ensure result is reasonable by constraining between neighboring percentiles
                let percentile = 100 * (1 - proportionRicher);
                percentile = Math.max(Math.min(percentile, percentile2), percentile1);
                
                const richerPeople = Math.floor(population * ((100 - percentile) / 100));
                
                return { 
                    percentile, 
                    richerPeople,
                    alpha,
                    x_min
                };
            }
            
            // Step 4: Fallback to linear interpolation between closest points
            // This handles cases where the wealth falls between thresholds but wasn't caught earlier
            let closestLower = -Infinity;
            let closestUpper = Infinity;
            let lowerPercentile = 0;
            let upperPercentile = 100;
            
            for (let i = 0; i < points.length; i++) {
                if (points[i] < wealth && points[i] > closestLower) {
                    closestLower = points[i];
                    lowerPercentile = percentiles[i];
                }
                if (points[i] > wealth && points[i] < closestUpper) {
                    closestUpper = points[i];
                    upperPercentile = percentiles[i];
                }
            }
            
            // If we found valid bounds, interpolate
            if (closestLower > -Infinity && closestUpper < Infinity) {
                const percentile = lowerPercentile + 
                    (upperPercentile - lowerPercentile) * 
                    ((wealth - closestLower) / (closestUpper - closestLower));
                
                return {
                    percentile: percentile,
                    richerPeople: Math.floor(population * ((100 - percentile) / 100)),
                    alpha: 1, // Default alpha for fallback
                    x_min: null
                };
            }
            
            // Final fallback - just use the closest percentile
            if (closestLower > -Infinity) {
                return {
                    percentile: lowerPercentile,
                    richerPeople: Math.floor(population * ((100 - lowerPercentile) / 100)),
                    alpha: 1,
                    x_min: null
                };
            }
            
            if (closestUpper < Infinity) {
                return {
                    percentile: upperPercentile,
                    richerPeople: Math.floor(population * ((100 - upperPercentile) / 100)),
                    alpha: 1,
                    x_min: null
                };
            }
            
            // This should never happen, but just in case
            return {
                percentile: 50, // Default to median
                richerPeople: Math.floor(population * 0.5),
                alpha: 1,
                x_min: null
            };
        }
        
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        function formatCurrency(value) {
            // For negative values
            if (value < 0) {
                return "-$" + formatNumber(Math.abs(value));
            }
            // For positive values
            return "$" + formatNumber(value);
        }
        
        // Function to create percentile table
        function createPercentileTable(isUnder18 = false) {
            const tableElement = document.getElementById(isUnder18 ? 'percentileTableUnder18' : 'percentileTable');
            const points = isUnder18 ? under18WealthPoints : adultWealthPoints;
            const percentiles = isUnder18 ? under18PercentilePoints : adultPercentilePoints;
            const population = isUnder18 ? under18Population : adultPopulation;
            
            // Create a table showing wealth thresholds for each percentile chunk
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <tr style="background-color: #f2f2f2;">
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Percentile</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Wealth Threshold</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Richer Population</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Poorer Population</th>
                    </tr>`;
            
            // Add rows for percentile bands
            for (let i = 1; i < percentiles.length - 1; i++) {
                const lowerPercentile = percentiles[i-1];
                const upperPercentile = percentiles[i];
                const wealthThreshold = points[i];
                
                // Calculate richer and poorer populations
                const richerPopulation = Math.floor(population * (100 - upperPercentile) / 100);
                const poorerPopulation = Math.floor(population * lowerPercentile / 100);
                
                tableHTML += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center">${lowerPercentile}% - ${upperPercentile}%</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right">${formatCurrency(wealthThreshold)}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right">${formatNumber(richerPopulation)}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: right">${formatNumber(poorerPopulation)}</td>
                    </tr>`;
            }
            
            tableHTML += `</table>
                <p><em>Note: This table shows the minimum wealth required to enter each percentile band, along with how many people are richer and poorer than this wealth threshold.</em></p>`;
            
            tableElement.innerHTML = tableHTML;
        }
        
        function calculatePercentile(isUnder18 = false) {
            // Get the correct elements based on whether it's for under 18 or adults
            const wealthInput = isUnder18 ? 
                document.getElementById('userWealthUnder18') : 
                document.getElementById('userWealth');
            
            const resultElement = isUnder18 ? 
                document.getElementById('resultUnder18') : 
                document.getElementById('result');
            
            const detailedResultsElement = isUnder18 ? 
                document.getElementById('detailedResultsUnder18') : 
                document.getElementById('detailedResults');
            
            // Get wealth value (remove spaces before parsing)
            const wealth = parseFloat(wealthInput.value.replace(/\s/g, ''));
            
            if (isNaN(wealth)) {
                resultElement.innerText = 'Please enter a valid wealth amount.';
                return;
            }
            
            // Select appropriate data points based on age group
            const points = isUnder18 ? under18WealthPoints : adultWealthPoints;
            const percentiles = isUnder18 ? under18PercentilePoints : adultPercentilePoints;
            const population = isUnder18 ? under18Population : adultPopulation;
            const ageGroup = isUnder18 ? "under-18s" : "adults";
            
            // Calculate using Pareto distribution
            const paretoResult = paretoEstimate(wealth, isUnder18);
            
            // Display result
            resultElement.innerHTML = 
                `<strong>Your wealth of ${formatCurrency(wealth)} places you at the ${paretoResult.percentile.toFixed(6)}% percentile among ${ageGroup}.</strong><br>` +
                `Approximately ${formatNumber(paretoResult.richerPeople)} ${ageGroup} are wealthier than you.`;
            
            // Create percentile table for the appropriate age group
            createPercentileTable(isUnder18);
            
            // Display simplified results
            detailedResultsElement.innerHTML = ``;
        }
        
        // Create percentile tables for both age groups on page load
        document.addEventListener('DOMContentLoaded', function() {
            createPercentileTable(false); // Adult table
            createPercentileTable(true);  // Under 18 table
        });
    </script>
</body>
</html>